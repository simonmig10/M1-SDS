---
title: "Exam"
author: "Simon"
date: "22/9/2021"
output: html_document
---

---
title: "Exam"
author: "Simon"
date: "22/9/2021"
output: html_document
---


```{r}
library(tidyverse)

library(lubridate)

library(magrittr)

library(FactoMineR)

library(factoextra)

library(uwot)

library(skimr)

library(GGally)
```


# load data

```{r}
data <- read_csv("startup data.csv", 
col_types = cols(founded_at = col_date(format = "%m/%d/%Y"), 
first_funding_at = col_date(format = "%m/%d/%Y"), 
last_funding_at = col_date(format = "%m/%d/%Y")))
```

# data celaning

We take a quick look at the data
```{r}
glimpse(data)

```


We start by removing columns we dont know what is as they are not described when loading the dataset.
Also some of the columns show the same thing, 

```{r}

data %<>%
  select(!c(`Unnamed: 0`, `Unnamed: 6`, status, state_code.1, object_id, avg_participants))

glimpse(data)

```

To look how wholesome the data is we skim the data

```{r}

skim(data)

```

```{r}

data %<>%
  mutate(closed_at= replace_na(closed_at, "still going"))

```


```{r}
skim(data)
```


```{r}

#We make intervals for first milestone
data %<>%
  mutate(age_first_milestone_year= ifelse(age_first_milestone_year <0,"before year 0",ifelse(age_first_milestone_year <= 3 , "[0-3]", ifelse(age_first_milestone_year <= 6, "]3-6]", ifelse(age_first_milestone_year <=9, "]6-9]", ifelse(age_first_milestone_year > 9, "over 9", "")))))) %>%
  mutate(age_first_milestone_year= replace_na(age_first_milestone_year, "no milestone"))

#We make intervals for last milestone
data %<>%
  mutate(age_last_milestone_year= ifelse(age_last_milestone_year <0,"before year 0",ifelse(age_last_milestone_year <= 3 , "[0-3]", ifelse(age_last_milestone_year <= 6, "]3-6]", ifelse(age_last_milestone_year <=9, "]6-9]", ifelse(age_last_milestone_year > 9, "over 9", "")))))) %>%
  mutate(age_last_milestone_year= replace_na(age_last_milestone_year, "no milestone"))

skim(data)

data %>% 
  count(is_software, is_consulting, is_ecommerce, is_web, is_mobile, is_enterprise)

data %<>% 
  mutate(active = labels == 1) %>%
  mutate(is_CA = is_CA ==1) %>% 
  mutate(is_software = is_software==1)

data %<>% 
  mutate(state_code = ifelse(data$state_code %in% c("CA", "NY", "MA", "TX"), data$state_code, "other"))

data %<>% 
  mutate(category_code = ifelse(data$category_code %in% c("software", "web", "mobile", "enterprise", "advertising", "gamesvideo", "ecommerce", "biotech", "consulting"),category_code, "other"))

```

```{r}

data %<>%
  filter(percent_rank(funding_total_usd) <0.99) %>% 
  filter(percent_rank(funding_rounds) <0.99) %>% 
  filter(percent_rank(relationships) <0.99) %>% 
  filter(percent_rank(age_first_funding_year) <0.99) %>% 
  filter(percent_rank(age_last_funding_year) <0.99) %>% 
  filter(percent_rank(age_first_milestone_year) <0.99) %>% 
  filter(percent_rank(age_last_milestone_year) <0.99)
```

# EDA

```{r, fig.height=12, fig.width=12, warning=FALSE}
library(GGally)
data %>% 
  select(funding_total_usd, funding_rounds, relationships,age_first_funding_year, age_last_funding_year, milestones, active) %>%
  ggpairs(legend = 1,
          mapping = ggplot2::aes(colour=active, alpha = 0.5), 
          lower = list(continuous = wrap("smooth", alpha = 0.3, size=0.1))) +
  theme(legend.position = "bottom")

```
Ja vi kan droppe de to ringe.

Så laver vi nogle lækre summary stats
```{r}
data %>% 
  group_by(active) %>% 
  select(relationships, milestones, funding_rounds, funding_total_usd) %>% 
  summarise_if(is.numeric, mean, na.rm = TRUE)
```
Og så videre til PCA.

# Unsupervised ML

Should we scale the data?

```{r}
options(scipen = 999)

data_num = data %>% 
  select(funding_total_usd, funding_rounds, relationships,age_first_funding_year, age_last_funding_year, milestones)

s_deviation=apply(data_num,2, sd)

mean1=colMeans(data_num)

scale= as.data.frame(s_deviation, row.names = c("sd"))%>%
cbind(as.data.frame(mean1, row.names = "mean"))%>%
print()
```
We can se the data is gonna need scaling to peform pca, because our variables is not on the same scale. Namely funding_total_usd seems much higher.

```{r warning=FALSE}
pca_data = data %>% 
  select(funding_total_usd, funding_rounds, relationships,age_first_funding_year, age_last_funding_year, milestones)

res_pca <- pca_data %>%
  PCA(scale.unit = TRUE, graph =FALSE)


```

```{r}
res_pca %>% 
  fviz_screeplot(addlabels = TRUE, 
                 ncp = 10, 
                 ggtheme = theme_gray())
```
We can see the elbow shows the optimal dimensions are two dimensions with almost 80% explained variance. Then we visualize our reduced data in two dimensions.

```{r, fig.height=7, fig.width=9, warning=FALSE}
res_pca %>%
  fviz_pca_biplot(alpha.ind = "cos2",
                  col.ind = "contrib",
                  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                  geom = "point",
                  ggtheme = theme_gray())
```
From the plot we can see, that the x-axis split our six variables into two groups so to say. Where the ones involving funding, funding rounds, milestone and relationships are above the x-axis and our two variables involving the age of a firm during its first and last funding is below. 

```{r, fig.height=7, fig.width=9, warning=FALSE}
res_pca %>%
fviz_pca_biplot(alpha.ind = "cos2",
habillage = data %>% pull(state_code) %>% factor(),
addEllipses = TRUE,
geom = "point",
ggtheme = theme_gray())

```

## UMAP
```{r}
res_umap <- pca_data  %>%
umap(n_neighbors = 15,
     metric = "cosine",
min_dist = 0.01,
scale = TRUE)
```

```{r}
res_umap %>%
as_tibble() %>%
ggplot(aes(x = V1, y = V2, fill = data$active)) +
geom_point(shape = 21, alpha = 0.5)
```
## Clustering

```{r}
pca_data %>%
scale() %>%
fviz_nbclust(kmeans, method = "wss")
```
Seems like the optimal number of clusters is somewhere around 3 or 4 clusters, so we try both

```{r}
res_km3 <- pca_data %>%
scale() %>%
kmeans(centers = 3, nstart = 20)

res_km4 <- pca_data %>%
scale() %>%
kmeans(centers = 4, nstart = 20)
```

```{r}
res_km
```

```{r}
par(mfrow=c(2,1))
res_km3 %>%
fviz_cluster(data = pca_data ,
ggtheme = theme_gray())

res_km4 %>%
fviz_cluster(data = pca_data ,
ggtheme = theme_gray())
```

```{r}
data[,"cluster3"] <- res_km3$cluster
data[,"cluster4"] <- res_km4$cluster
table(data$cluster4, data$category_code)
```

```{r}
data[,"pca1"] <- res_pca$ind$coord[,1]
data[,"pca2"] <- res_pca$ind$coord[,2]
```

```{r}
data %>%
  group_by(cluster4) %>%
  summarise(pca1 = pca1 %>% mean(),
            pca2 = pca2 %>% mean())
```

```{r}
par(mfrow=c(2,1))
data %>%
ggplot(aes(x=pca1, y=pca2, color=factor(cluster3)))+
geom_point()
data %>%
ggplot(aes(x=pca1, y=pca2, color=factor(cluster4)))+
geom_point()
```



